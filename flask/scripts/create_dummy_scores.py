#! /usr/bin/env python

import random

from collections import defaultdict

from geoalchemy2.comparator import Comparator
from geoalchemy2 import functions as func
from sqlalchemy import create_engine, select
from sqlalchemy.orm import Session, joinedload
from sqlalchemy.dialects.postgresql import insert
from shapely import wkb, from_wkt


from api.models import (
    Budget,
    BudgetScore,
    DisseminationArea,
    ImprovementFeature,
    Metric,
)
from api.settings import app_settings

DOWNTOWN_COORDS = """
    POLYGON ((-79.3969234507697 43.6340068188879, -79.3972006575725 43.6343072017205, -79.3972195923893 43.6343302262884, -79.3973296025414 43.6344640317283, -79.39749371737 43.6346590950077, -79.3979793891459 43.6352363742228, -79.3981418631448 43.635429481781, -79.3982607451577 43.6355668047437, -79.3983378140058 43.6356440871782, -79.3983655357753 43.6356750045771, -79.3984037776984 43.6357144556295, -79.3984767427553 43.6357781422318, -79.3985946069149 43.6358583051497, -79.3986971410331 43.6359234130495, -79.3987832649903 43.6359745091771, -79.3988502434639 43.6360093498054, -79.3989362531362 43.6360548378541, -79.399368869224 43.6362598209318, -79.3994403968871 43.6363020553524, -79.3994947303873 43.6363394048645, -79.399577523679 43.6364042065677, -79.3996093995545 43.6364343801953, -79.3996464416555 43.6364806348185, -79.3996496820122 43.6364847152893, -79.3997209370212 43.6366315633602, -79.3998154130225 43.6368263280897, -79.4000179526491 43.6373416364792, -79.4000308918897 43.637371514378, -79.4002406372196 43.6378561699234, -79.400286781913 43.6379599330882, -79.4003095045157 43.6380247358391, -79.400346126847 43.6381084175951, -79.4004356458073 43.6383129529389, -79.400649567486 43.6388394677038, -79.4006628744541 43.6388722172827, -79.4012713564689 43.6403697455257, -79.4013481333008 43.6405558522534, -79.4014219974625 43.6407497966103, -79.401681304196 43.6413882894473, -79.4017360426453 43.6415230600884, -79.4018953460164 43.6419152697734, -79.4021958970367 43.6426553591922, -79.4023967156926 43.6431940739398, -79.4027055346973 43.6439263197171, -79.4029007329138 43.6444122356407, -79.4029555842023 43.6445419019458, -79.4031055655183 43.6448904361813, -79.4032337335071 43.6451920095979, -79.4033696503018 43.6455165879014, -79.4037609527593 43.6464717470678, -79.4038893091694 43.6468225663001, -79.4040105032962 43.6471882946161, -79.404189629313 43.6476762468768, -79.4043275246903 43.6480262184081, -79.4043402422941 43.6480579408577, -79.4045893864322 43.6486794682127, -79.4046022524813 43.6487115598093, -79.4046496023591 43.648831398457, -79.4047025404117 43.6489686413757, -79.4050100559487 43.6497542571787, -79.4052480041434 43.6503621455504, -79.4054542866212 43.6508891029549, -79.40549965023 43.6510049879653, -79.4056046851306 43.6512675633906, -79.4056527332189 43.6513874021459, -79.4060223641094 43.6523116870524, -79.4068356616627 43.6542871512831, -79.4075388610114 43.6560265496159, -79.4077229391202 43.6564819597087, -79.4084685378366 43.6582892020326, -79.4090890590658 43.659806172143, -79.4094366129669 43.6607056373901, -79.4097692726385 43.6615148062126, -79.4102496943578 43.6626691384885, -79.4107165347888 43.6638302269134, -79.4112129935224 43.6651157436919, -79.4105942098506 43.6652543860771, -79.4099926645823 43.6653891771101, -79.4093189488455 43.6655251139253, -79.4086808432393 43.6656765845221, -79.4074731068106 43.6659145898168, -79.4066729949202 43.6660784748123, -79.406274120659 43.6661649573509, -79.4053548050255 43.6663588717851, -79.404518645863 43.6665237559916, -79.4038707379121 43.6666572878663, -79.402707177037 43.6669054424105, -79.4015389554648 43.6671618623125, -79.3998364772384 43.6675168720603, -79.3983645780234 43.6678316276818, -79.3973807918684 43.668033224743, -79.3958757476091 43.6683327872883, -79.3941414134514 43.6687202589369, -79.3910266247938 43.6693583258404, -79.3905851430825 43.6694474763638, -79.3895075819499 43.6696690607853, -79.3880184064428 43.6699744129918, -79.3874076299928 43.6700995075987, -79.3867880679966 43.6702263905041, -79.3860507571124 43.6703871147477, -79.3857192494022 43.6704593795273, -79.3842095596078 43.6708044294258, -79.3831604454174 43.6710464067823, -79.3823757534926 43.671221127933, -79.3805663805765 43.6716108185391, -79.379468072457 43.6718257155842, -79.379415257866 43.6718375506357, -79.3790683459522 43.6719153156726, -79.3768542863113 43.6723585445864, -79.3764557305198 43.6724481277896, -79.3763169504609 43.672465980367, -79.3761626906382 43.6724793153445, -79.376050684203 43.6724791849481, -79.3759524602155 43.6724706891652, -79.3758925984185 43.6724655024351, -79.374854938299 43.6723335368773, -79.3736051156246 43.6722063952516, -79.3731777789308 43.6721518959868, -79.3714584663306 43.6718889011165, -79.3714201102267 43.6718888489779, -79.3713821385331 43.6718888062603, -79.3713449232972 43.6718887643814, -79.3713069419867 43.6718932222911, -79.3712697391491 43.6718931804018, -79.3712321518823 43.6718931380673, -79.3711949421951 43.671902097472, -79.3711577393521 43.6719020555462, -79.3711205144774 43.6719065142465, -79.3710833047654 43.6719154736149, -79.3710464767074 43.6719199327386, -79.3710100454744 43.6719243922983, -79.3709735921933 43.6719333524845, -79.3709371609468 43.6719378120209, -79.3709015013272 43.6719467640788, -79.3708658292768 43.6719557251129, -79.3708301572158 43.6719646861358, -79.3707952540038 43.6719736480166, -79.3707603411236 43.6719871105388, -79.3707258471202 43.6719960728611, -79.3706971470973 43.6720095423898, -79.3699848093236 43.6725263376393, -79.369916694932 43.6725757494329, -79.3688335742863 43.6733306409999, -79.3682041043128 43.6737754914982, -79.3673701084725 43.674368641197, -79.3672723081543 43.6744315369373, -79.3671861823986 43.6744809441749, -79.3670915242786 43.674530341427, -79.3669988105768 43.6745752402017, -79.3668778213051 43.6746201059758, -79.3667812778382 43.674647006471, -79.3667358881175 43.674669456869, -79.3663129006612 43.6747679775049, -79.3647396343334 43.6750676800045, -79.3644553276428 43.675122485333, -79.364322411161 43.6751480984315, -79.3642522741655 43.6751616251605, -79.3633907880318 43.6753226406503, -79.3631022069076 43.674921754632, -79.3630267443529 43.6748721659679, -79.3629854293127 43.6748091072048, -79.3629491677059 43.6747325525026, -79.3629109920462 43.6746469941707, -79.3628863529843 43.6745749540452, -79.3628803490964 43.6744939349465, -79.3628797706027 43.6743994203713, -79.362902471786 43.6743094253768, -79.362929017321 43.6742194439876, -79.3629424253744 43.6741204455173, -79.3629647046905 43.6740304590016, -79.3629889002357 43.6739539767611, -79.3630084780898 43.6738684876577, -79.3630273053339 43.6737694866643, -79.3630429912276 43.6736884935503, -79.3630444105773 43.6736369536738, -79.3630451122287 43.6736119848435, -79.3630553334066 43.673539995503, -79.3630566731066 43.673463485858, -79.3630424907711 43.6733959589396, -79.3630104857256 43.6733239099995, -79.3629509829299 43.6732428267617, -79.3628635408793 43.6731887229505, -79.3628565096811 43.6731831426956, -79.3627896513677 43.6731301256769, -79.3626913338069 43.673075999677, -79.3625755700821 43.6730263622832, -79.3624462006984 43.67299920271, -79.362327684542 43.6729765657255, -79.3622385655624 43.6729674570349, -79.3621692655611 43.6729358688622, -79.3620966503622 43.6729223423061, -79.3620476121634 43.672913218803, -79.3619558827152 43.6728636007814, -79.361852490186 43.6728274705781, -79.3617588161233 43.6727823507098, -79.361666303779 43.6727282308455, -79.3615664170575 43.6726831033004, -79.3614650321125 43.6726154705397, -79.3613655839834 43.6725523497012, -79.3612595490858 43.6724847111173, -79.3611693814464 43.6724305936939, -79.3610710768678 43.6723719656473, -79.3609724192171 43.6722998350981, -79.3608768308655 43.6722412101866, -79.3607901570211 43.6721780953884, -79.3607749076639 43.6721656729899, -79.3607015696445 43.672105967865, -79.3606137428881 43.6720428515266, -79.3605255527314 43.6719707333508, -79.3604567539121 43.6718896374532, -79.3604023031457 43.6718085590359, -79.360344719026 43.6717364780898, -79.3602786469743 43.6716508757485, -79.3602249759621 43.6715652975332, -79.3601782867836 43.6714797278316, -79.3601300580848 43.6713896555625, -79.3600903488919 43.6712995936992, -79.3600514105891 43.6712140424295, -79.3600059065847 43.6711149721123, -79.3599635048351 43.6710204152409, -79.3599230501765 43.6709258427354, -79.3598767777553 43.6708267714203, -79.3598374537321 43.6707367099325, -79.359795042056 43.6706466446428, -79.3597530130063 43.6705520791414, -79.3597136912644 43.6704665182737, -79.3597108499133 43.6704618791026, -79.3596584949156 43.6703764372387, -79.3595936348185 43.6702773519791, -79.3595128144168 43.6702052420519, -79.3594203710756 43.6701241164448, -79.3593294713202 43.6700564946546, -79.359233503709 43.6699978678798, -79.3591251357473 43.6699392257427, -79.3590264862754 43.6698715941587, -79.3589429427058 43.6698084817946, -79.3588493034532 43.6697408562385, -79.3587456305749 43.6696687175421, -79.3586430565379 43.6696145827689, -79.358541650159 43.6695649500129, -79.3584627452901 43.6695018430347, -79.3583892613951 43.6694432433821, -79.3583134463635 43.6693846407922, -79.3582302532352 43.6693260290014, -79.3581880315379 43.669293652854, -79.3581420717074 43.669258409629, -79.3580588807146 43.66920429838, -79.3579710521313 43.669150181308, -79.3578851652186 43.6690825645863, -79.3578058754617 43.6690149650071, -79.3577529490107 43.6689473891798, -79.3577457234237 43.6689300166214, -79.3576861148549 43.6688617933519, -79.3576087831197 43.6687896864044, -79.3575570227142 43.6687221119361, -79.3575079869779 43.6686455395089, -79.3575022384777 43.6686328404663, -79.3574651940938 43.6685509721816, -79.3574274269319 43.6684654124363, -79.3573846094798 43.6683708540465, -79.3573461057093 43.6682717913552, -79.3573207284055 43.6681907476975, -79.357183512638 43.667697024303, -79.3565773418938 43.665516421248, -79.3565315154114 43.6653903450368, -79.3564976705079 43.6652732671799, -79.3564630536116 43.6651471870047, -79.3564299884733 43.6650256094335, -79.3563992545952 43.6649040257774, -79.3563746974266 43.6647869595412, -79.3563478447871 43.6646653897439, -79.356303952117 43.6645347971815, -79.3563035951961 43.664533680567, -79.3562670082609 43.6644177243446, -79.356230086051 43.6642916411814, -79.3561997158193 43.6641790682529, -79.3561562329782 43.6640484851396, -79.3561274467929 43.6639269218432, -79.3560863448847 43.6637963686982, -79.3560467359766 43.6636793284252, -79.3559974988811 43.6635442643282, -79.3559594741517 43.6634182156748, -79.3559141506731 43.6632696634591, -79.3558803899819 43.6631391104767, -79.3558551617196 43.6630493173067, -79.3558373963304 43.6629860514892, -79.3558051858261 43.6628555094344, -79.3557598615671 43.6627024384691, -79.3557175941774 43.6625673740213, -79.3556641118228 43.6624142927131, -79.3556132895883 43.6622792084166, -79.3556112843276 43.6622726259035, -79.3555694573589 43.6621351315849, -79.3555221536248 43.6619910593467, -79.3554798608839 43.66185148509, -79.3554502356459 43.6617343941827, -79.3554445488862 43.661711919642, -79.3554146569307 43.6615768617064, -79.3553781905609 43.6614327940999, -79.3553397809453 43.6612977253617, -79.3552940250754 43.6611446536239, -79.3552559877914 43.6610095853222, -79.3552195335153 43.6608814230398, -79.3552098820444 43.6608475027552, -79.3551702953055 43.6607124324554, -79.3550760750147 43.66041976937, -79.3550322454114 43.660275692289, -79.3550253646987 43.6602548724549, -79.3549860742635 43.6601361128894, -79.3549418498699 43.6599965449394, -79.3548972289513 43.6598569674643, -79.3548483338921 43.6597263858865, -79.3548045285992 43.6595777990576, -79.3547691853904 43.6594472346516, -79.3547323157895 43.6593121676191, -79.3547303688018 43.6593020656349, -79.3547089651593 43.6591906197738, -79.3546767684845 43.659051048982, -79.3546456800052 43.6589249906079, -79.3546030210197 43.6587899161598, -79.3545603048597 43.6586683346388, -79.3545187868791 43.658533261605, -79.3544814999141 43.6584071952862, -79.354450832182 43.6582766367068, -79.3544251749423 43.6581505851708, -79.3543956263341 43.6580290293437, -79.3543455357804 43.6579119480085, -79.3543248779628 43.6578719917054, -79.3542826739305 43.6577903496959, -79.3542050943883 43.6576642319021, -79.3541096462877 43.6575650952956, -79.3539855423223 43.6574524199859, -79.3538741898395 43.6573577635378, -79.3537551202754 43.6572451034106, -79.353646868013 43.6571504507038, -79.3535339763437 43.6570467996008, -79.3534187352905 43.6569611390696, -79.3533767111928 43.6569285993054, -79.3533081313592 43.6568754843716, -79.3532021878699 43.6567853438767, -79.3531016296468 43.656708703226, -79.353002293386 43.6566140613573, -79.3529397896443 43.6565658327446, -79.3528971223194 43.6565329139177, -79.3527942327014 43.6564517783195, -79.352689095205 43.6563571287039, -79.3526071363221 43.6562850122545, -79.3525154950249 43.6562128832539, -79.3524207751926 43.6561272481785, -79.3523341677926 43.6560551345305, -79.352249108967 43.6559785131408, -79.3521513139107 43.6558883731884, -79.3520658615046 43.6558207615037, -79.3519781006713 43.6557441364125, -79.3517417941799 43.6555656754336, -79.3508387523873 43.6547691051895, -79.3496600426458 43.6537293989674, -79.3495236876076 43.6535994380291, -79.349518196323 43.6535942010135, -79.3486507298012 43.652531507943, -79.3481765474944 43.6519547113079, -79.3481408247943 43.6519182533682, -79.3479975149471 43.651747046111, -79.3478580860739 43.6515758528357, -79.3477236109952 43.651411822064, -79.3474207493205 43.6509892815202, -79.3473220457633 43.650803811755, -79.3472969332 43.6507487979107, -79.3474651937934 43.6505131959369, -79.3476541079523 43.6504189245783, -79.3542669036609 43.6476803573966, -79.3543455109667 43.6476477916299, -79.354405817955 43.6476219175207, -79.3593578631225 43.6454969358376, -79.3594281129026 43.6455854876848, -79.3600790062967 43.6464015220207, -79.3607515723032 43.6472124571607, -79.3598538981138 43.6452985787937, -79.3536843702146 43.6380668863781, -79.349647800299 43.6333942966004, -79.3525152582638 43.6337126393982, -79.3520379985101 43.6333037467897, -79.3511967102871 43.6325600763609, -79.3511797145488 43.6325420514611, -79.3502847042444 43.6317668174165, -79.3493872836886 43.6310230779534, -79.3494756815638 43.6309826791236, -79.3495339685719 43.6309062440365, -79.3495455442205 43.6307667377164, -79.3495850689954 43.6305957633006, -79.3496112480158 43.6304790046926, -79.3496792683676 43.6301267076795, -79.349692142025 43.6298987733564, -79.3497171540012 43.6297379153541, -79.3497604744627 43.6296396320817, -79.3497670774446 43.6294563904065, -79.3497797391291 43.629313374911, -79.3498234931558 43.6290407891958, -79.3498849977907 43.6290498083593, -79.3498846863332 43.6291749543228, -79.3498659896489 43.6292732699911, -79.3498656002912 43.6294296956877, -79.3498345869273 43.6295324508598, -79.349828149783 43.6296441856923, -79.3499388227166 43.6296800845523, -79.3502094354829 43.629734060748, -79.3504739810571 43.6297612042179, -79.3509907301687 43.6298154912369, -79.3513968183899 43.629833878595, -79.3521166277523 43.6298839326073, -79.3525965828634 43.6298890081611, -79.3532673362382 43.6298764319882, -79.3538212345828 43.6298413700633, -79.3542212945406 43.6298061003826, -79.3544121352382 43.6297705810501, -79.3545054018817 43.629595037613, -79.3545526999552 43.629575825818, -79.3546055808412 43.6294768777646, -79.3546821941519 43.6293464549793, -79.3547611445843 43.6292025330189, -79.3548288781822 43.6290541050614, -79.3549175509549 43.6288967022419, -79.3550069575637 43.6287482926726, -79.355090968437 43.6285863831, -79.355175771946 43.6284244744651, -79.3552846014446 43.6282580864807, -79.3553844865506 43.6281006974697, -79.3558308983049 43.6274666989304, -79.3559408320384 43.6273138227813, -79.3560674535799 43.6271519661374, -79.3561924487086 43.6270171114934, -79.3563229029938 43.6268687614749, -79.3564661448175 43.6267204273598, -79.356623719649 43.6265631096407, -79.3567762519894 43.6264102860815, -79.3569400013478 43.6262664777502, -79.3578217925513 43.6254492066633, -79.3589299040671 43.6246295617448, -79.3595320650568 43.624211062971, -79.3599847204703 43.6239255177174, -79.3601823759662 43.6237576674488, -79.3613626691066 43.6229031345063, -79.3620852358659 43.6223973914765, -79.3633207811359 43.6215892619876, -79.3645223136665 43.6206950522781, -79.3656437964577 43.6199222547568, -79.3664531220754 43.619338102491, -79.3666225926763 43.6192661990491, -79.3667151762915 43.6191969061624, -79.366810862165 43.6191253754632, -79.3669835893413 43.6190539253479, -79.3670668183087 43.6190405920544, -79.3671397763815 43.6190213868464, -79.3671761979662 43.6190463180664, -79.3675863513867 43.6189035094274, -79.3678793580938 43.6187762354416, -79.3679657303914 43.6187360359164, -79.3683605497461 43.6185551398159, -79.3686350526857 43.6184345666304, -79.3688602187432 43.6183363227072, -79.3688910957571 43.6183072475601, -79.3689009356733 43.6182776802084, -79.369009884592 43.6182301426243, -79.3690993161497 43.6182011434992, -79.3692041288518 43.6181811183067, -79.3696267011059 43.617991302161, -79.3698550814483 43.6178258914027, -79.3698551490488 43.6177945485643, -79.3699168291141 43.6177699909029, -79.3701048673188 43.6177366204452, -79.3702497619532 43.6177099247744, -79.3704934370838 43.6175982595187, -79.3705613244438 43.6175446069751, -79.3706416170693 43.6174663405646, -79.3707187976458 43.6173947946324, -79.3707589571784 43.6173522993654, -79.3708081897622 43.617319598873, -79.3709734731316 43.6172597641181, -79.3710354402176 43.6172279780404, -79.3711206779513 43.6171774772241, -79.3711697556205 43.6171475398339, -79.3712291734211 43.6171026357192, -79.3712756898995 43.6170652062227, -79.3713351395349 43.6170052967328, -79.3713842488826 43.616960380934, -79.3714178755346 43.6169191832872, -79.3714489002981 43.6168779917059, -79.3714851398084 43.6168199373298, -79.3715084253824 43.6167824816192, -79.3715343163182 43.616737530654, -79.3715525957635 43.6166363573037, -79.3715578136702 43.6166063704563, -79.3715657087181 43.6165351691431, -79.3715657924779 43.6164958150564, -79.3715683970026 43.616477077039, -79.3715813228726 43.6164695933818, -79.371620015018 43.6164640109551, -79.3716741945172 43.6164640717845, -79.3717025825079 43.6164566144703, -79.3717206858778 43.6164322679581, -79.3717620032291 43.6164098287808, -79.3719448519067 43.6163381484502, -79.3720370232103 43.6163589639108, -79.3722277411952 43.6164499744896, -79.3722763080257 43.616467680533, -79.3723353141221 43.6164702668372, -79.3725089895014 43.616412455541, -79.3726271400068 43.6163520617339, -79.3726966400747 43.6163193559975, -79.3727800269686 43.6162816158798, -79.3728669306277 43.6162211870468, -79.3729989477611 43.61617090786, -79.3731622144832 43.6161130840045, -79.3732386732867 43.616070295072, -79.373332516087 43.6160149143689, -79.3734020241644 43.6159721176247, -79.3734888685949 43.61593943061, -79.3737147004097 43.6158463626319, -79.3738780499076 43.6157481844989, -79.3739510492402 43.615700350478, -79.3740935082812 43.615632411757, -79.3741977548052 43.6155720010043, -79.3743311407606 43.6154700356522, -79.3744686492078 43.6153931976203, -79.3745848771167 43.6153319805386, -79.3746736147148 43.615293731822, -79.3747412280863 43.6152615988586, -79.3747771835371 43.6152309704247, -79.3747941306222 43.6152018424021, -79.3748258262746 43.6151880779405, -79.3749187504344 43.6151621025465, -79.3749969283931 43.6151315202316, -79.375102599609 43.6150702910771, -79.3752315197817 43.614993748787, -79.3753308691395 43.6149279037951, -79.3753985168669 43.614872762858, -79.3754906218841 43.6147930926556, -79.3755560014923 43.6147081994718, -79.3756523972106 43.6146383723557, -79.3758416594589 43.6145336845491, -79.3759345436199 43.6144963304917, -79.375996445818 43.6144814102939, -79.3760239805075 43.6144664527978, -79.3760446494545 43.6144465010659, -79.3760824816177 43.614436550507, -79.3761649633636 43.6144391332748, -79.3763127422785 43.6144567920105, -79.3764020693399 43.6144743693725, -79.3764776824442 43.6144794468824, -79.3767045779798 43.6144671978466, -79.3768695692506 43.6144648912788, -79.3770070588606 43.6144675326721, -79.3770757960337 43.6144726023888, -79.377099886253 43.6144576499312, -79.3771686946005 43.6144277491632, -79.3771893580821 43.6144102906108, -79.3773647962345 43.614345542718, -79.3775746621744 43.6142508657099, -79.3778911617053 43.6141188473632, -79.3779639030311 43.6140551409907, -79.3782310864427 43.6139812542088, -79.3783688718941 43.6139349445692, -79.3784869813448 43.6138957699784, -79.3786100090822 43.6138566004878, -79.3787379407541 43.6138245741908, -79.3788412657685 43.6137996688009, -79.3789937626234 43.6137748243764, -79.3791757484775 43.6137607316075, -79.3793577128341 43.6137573502138, -79.3795200372355 43.6137432271453, -79.3796282445798 43.6137361940041, -79.3796971239741 43.6137255458187, -79.379761100988 43.613700607185, -79.3798940515296 43.6136114168635, -79.3799876312325 43.6135400528781, -79.3801205739872 43.6134544358457, -79.380209185125 43.6134080814095, -79.3803027357894 43.6133510113862, -79.380445514465 43.613265404271, -79.3804898525228 43.6132225678695, -79.3805390859236 43.613197604383, -79.3806177959771 43.613183401352, -79.3806817437936 43.6131727474223, -79.3807506435434 43.613151377932, -79.3808195237986 43.6131335819432, -79.3808736700349 43.6131050498703, -79.3809377217443 43.6130479485818, -79.3810875902853 43.6129094737052, -79.3812813270171 43.6127772641735, -79.3813663250136 43.6127403205677, -79.3814471038431 43.6126879530909, -79.3815322045531 43.6125985671946, -79.3815875236039 43.6125338322843, -79.3816428367778 43.6124783508004, -79.3816980651748 43.6124660670176, -79.3817702966266 43.6124445473335, -79.3818808193976 43.6123798693568, -79.3819998767832 43.61229668416, -79.3820636578514 43.6122566396451, -79.3821249037213 43.6122396271159, -79.382182960288 43.6122253657018, -79.3822302762555 43.6123251591961, -79.382288424435 43.6122830114221, -79.3824046406385 43.612252445182, -79.3826739063801 43.6122412270261, -79.3827953279071 43.6122413515737, -79.3829115016287 43.6122261231954, -79.3830329528703 43.6122109000988, -79.3833392998018 43.612134503015, -79.3834607655608 43.6121116102679, -79.3835663837294 43.612096370463, -79.3836719722636 43.6120964779529, -79.3837722708412 43.6120965799674, -79.3838145111594 43.6120927882987, -79.3838990631984 43.6120545191429, -79.3840152878856 43.6120124384553, -79.3841684014326 43.6120049244823, -79.384316200632 43.6120165779535, -79.3844957143463 43.6120090902537, -79.384701637812 43.6119901160928, -79.3848072627758 43.6119710405425, -79.3848970206598 43.6119634617379, -79.3850395350211 43.6119789525599, -79.3853245858562 43.6119984118738, -79.3855708447945 43.6120130068937, -79.3857486697257 43.6120075048501, -79.385925091717 43.6120101384146, -79.3860539986083 43.6120151997488, -79.3862269905126 43.6120301613755, -79.386484787516 43.6120624627024, -79.3866340383668 43.6120798665264, -79.3868070259763 43.6120972936603, -79.3869969999921 43.6121073471574, -79.3872785818916 43.6121076251435, -79.3875465830255 43.612122687414, -79.387658548593 43.6121178557145, -79.3878858603733 43.6121156214741, -79.3880147768282 43.6121157388266, -79.3880690639544 43.6121157919911, -79.3881131780551 43.6121035122287, -79.3881776819419 43.6120789204483, -79.3882184412825 43.612051848029, -79.3882519407522 43.611998052281, -79.3883085055386 43.61199235565, -79.3883486436968 43.6119862558883, -79.3883697464617 43.6119970151915, -79.3883844977263 43.6120123770175, -79.3884140353669 43.6120308227596, -79.3884541536928 43.6120354616369, -79.3884942748521 43.6120385702612, -79.388521760321 43.6120278583709, -79.3885344498622 43.6120125233211, -79.3885640413811 43.612001813474, -79.3885978375937 43.612001846412, -79.388621057807 43.6120064687629, -79.3886358374568 43.6120064831611, -79.3886527355644 43.6120064996208, -79.3886675208765 43.6120034445358, -79.3886759840759 43.6119957835665, -79.3886886802987 43.6119835179907, -79.3886971661353 43.6119635791034, -79.3887098482054 43.6119589827221, -79.3887330853707 43.6119544056144, -79.3887711060802 43.6119544426127, -79.3888027809911 43.6119560036678, -79.3888576761017 43.6119621960185, -79.3889590268805 43.6119761026854, -79.3890540301678 43.6119992205578, -79.3891300169738 43.6120223109091, -79.3891785421433 43.6120499743186, -79.3892102058295 43.6120576832204, -79.3892482181639 43.6120623197781, -79.3892714328026 43.6120700204775, -79.3892967631172 43.6120792444611, -79.3893241938663 43.6120915489584, -79.389336861837 43.6120946307063, -79.3893579636654 43.6120992598583, -79.3893854012156 43.6121146248307, -79.3894086018389 43.6121299946992, -79.3894339293633 43.612140766894, -79.3894507954503 43.6121515218999, -79.3894782555153 43.6121546179349, -79.3895141354123 43.6121669305545, -79.3895436723373 43.6121792280331, -79.3895795657915 43.6121976886157, -79.3896777363451 43.6122437806539, -79.3897639442667 43.6123008518077, -79.3898514147297 43.6123993486498, -79.3898592538942 43.6124688291656, -79.3898591183728 43.6125498778238, -79.3898032490571 43.612601933206, -79.3896757051874 43.6126365376724, -79.3896755993676 43.6126944257029, -79.3897073699019 43.6127523534915, -79.3896673811742 43.6128391516029, -79.3896434090525 43.6128796528567, -79.3896113737829 43.6129664586238, -79.3896112361239 43.6130417193599, -79.3896588983396 43.6131286020656, -79.3897145566672 43.6131923408139, -79.3898100771581 43.6132387362224, -79.3898418991223 43.6132619275413, -79.3898976105624 43.6132967266879, -79.3899053759848 43.6134067225053, -79.3899050926669 43.6135688197822, -79.389936811102 43.6136556870088, -79.3900720507754 43.613777390288, -79.3902152131648 43.6139164647489, -79.3903186486972 43.6139918338905, -79.3903823483084 43.6140150466339, -79.3904619382614 43.6140614352164, -79.390621025989 43.6142121092447, -79.3906996150779 43.6143051600512, -79.3907482373045 43.614362743588, -79.3907959526658 43.6144148893812, -79.3908515610379 43.6145075670704, -79.3909868548064 43.6145945418344, -79.3911221385387 43.614687295337, -79.3912972142499 43.6148090350776, -79.39144044438 43.6149133805788, -79.3915438851706 43.614994518512, -79.3916141534939 43.6150586392325, -79.3916400697063 43.6150943544159, -79.3916517802012 43.615134304799, -79.3916556307766 43.6151771011809, -79.3916528174443 43.6152052369415, -79.3916516316625 43.6152170366741, -79.3916161590183 43.6152940371678, -79.3915608667992 43.6154794139, -79.391548776886 43.6156505823509, -79.3915602075944 43.6158531520414, -79.3915913607025 43.6160015249061, -79.3916147358676 43.6161071066609, -79.391665606408 43.6162041541226, -79.3917909231427 43.6163925553925, -79.391865295634 43.616518159486, -79.3919193737047 43.6166509814803, -79.3921184436624 43.6169248484896, -79.3923396243096 43.6172302949175, -79.3925841317543 43.6175527124811, -79.392840300657 43.6178751404354, -79.3932013789228 43.6182739798174, -79.3933644203153 43.6184691385851, -79.3934226149186 43.6185539861434, -79.3934340167476 43.6187066156912, -79.3936903718068 43.6189357692376, -79.3938649687106 43.6191987816405, -79.3941445565363 43.619478831682, -79.3944241593306 43.6197588900413, -79.3944706554178 43.6198606668943, -79.3948552498759 43.620166250029, -79.3951116483453 43.620369971393, -79.3952048771901 43.6204463618269, -79.3952980768266 43.6205397198106, -79.3954961465048 43.620734898536, -79.3958924404499 43.621023530179, -79.3961838325593 43.6212442306191, -79.396393596058 43.6214224687366, -79.3967316114759 43.621668647983, -79.3971288283644 43.6219462674086, -79.3976104653477 43.6222906704946, -79.3980151621332 43.622575566645, -79.3981365006811 43.6227032247276, -79.3982577900884 43.6228603262277, -79.3984329847434 43.6230959587392, -79.3985138728364 43.6231843343451, -79.3987971064685 43.6234200621444, -79.3990938321494 43.6236656036698, -79.3993096862551 43.6238129669273, -79.3994176055243 43.6238915541593, -79.399606464937 43.6240290725669, -79.3997682309967 43.6242156335503, -79.3998895928315 43.6243334782285, -79.4000919409961 43.6244906396918, -79.4003752517666 43.6246870994835, -79.4007395065325 43.6249425160411, -79.4013600684978 43.6253943833933, -79.401670384923 43.6256007107748, -79.4019537538442 43.625767759095, -79.4023315126677 43.6260330116415, -79.4028712427036 43.626376901855, -79.4032914947171 43.6266379746427, -79.4033497559452 43.6266561887355, -79.4037478247418 43.6265638101833, -79.4039243133431 43.6265285021348, -79.4042866474789 43.6264410874429, -79.4046336743547 43.62715479226, -79.4046946297033 43.6272801515452, -79.4047625429054 43.6274332408946, -79.4047995691738 43.6275277954033, -79.4048385126924 43.6276403452864, -79.4048844223954 43.6277438995537, -79.4048993790719 43.6278384356606, -79.4048229809156 43.6279103832507, -79.4047009006316 43.6279778010198, -79.4045927272755 43.6280587233573, -79.4044729476257 43.6281441365914, -79.4043717217942 43.6282430763154, -79.4042325923073 43.6283239724093, -79.4041050489676 43.6284048870535, -79.4039813892336 43.6284902965124, -79.4038519101037 43.6285802016396, -79.403751093431 43.6286701397555, -79.4036305254725 43.6287510507365, -79.4035204305233 43.6288229690335, -79.4034177086063 43.6288949024542, -79.4033079756525 43.6289803229424, -79.4032083151542 43.6290747532469, -79.4030885263656 43.62915566431, -79.4029656485237 43.6292230795347, -79.4028772723999 43.6292815135481, -79.4027981706151 43.6293444560756, -79.4026873343177 43.6293983701446, -79.4026563319794 43.6294118458408, -79.4025981718327 43.6294523025742, -79.4014140638765 43.6301219183593, -79.4007966562003 43.6304499620815, -79.3987655310305 43.6315514189895, -79.3978540749822 43.6326778792284, -79.398088071824 43.6328501586117, -79.3982779902794 43.6329550589135, -79.3979229369802 43.6333620192249, -79.3976052429213 43.63355074624, -79.397591090701 43.633564937752, -79.3975928371648 43.6336311895258, -79.3975391139783 43.6336744110551, -79.397459280984 43.6337161149117, -79.3969234507697 43.6340068188879), (-79.3760513300226 43.6608058588976, -79.376511042498 43.6619159429765, -79.3765520042611 43.6620148489579, -79.3758995809324 43.6604393845593, -79.3760513300226 43.6608058588976), (-79.3743492740583 43.6629166337057, -79.3731509701568 43.6631710833555, -79.3730617801465 43.6631900221839, -79.3743492740583 43.6629166337057))
"""

downtown = from_wkt(DOWNTOWN_COORDS)


def get_is_downtown(feature):
    location = wkb.loads(str(feature.geometry))
    return downtown.contains(location)


def get_nearby_das(feature: ImprovementFeature, session: Session, limit=3):

    location = wkb.loads(str(feature.geometry))

    x, y = next(zip(location.xy[0], location.xy[1]))

    nearby_das = (
        session.execute(
            select(DisseminationArea)
            .order_by(
                Comparator.distance_centroid(
                    DisseminationArea.geometry,
                    func.ST_GeomFromText(f"POINT({x} {y})"),
                )
            )
            .limit(limit)
        )
        .scalars()
        .all()
    )

    return nearby_das


def get_greenspace_score(current_score=0):
    # we're not reverting greenspace access...
    if current_score == 1:
        return 1
    else:
        return random.sample([0, 0, 0, 0, 0, 1], 1)[0]


def get_score(da, metric, multiplier=3, downtown_multiplier=25, minimum=0):
    if get_is_downtown(da):
        multiplier = downtown_multiplier
    score = random.random() * multiplier
    return (
        get_greenspace_score(minimum)
        if metric.name == "greenspace"
        else score if score > minimum else minimum
    )


def create_dummy_scores(
    session: Session, metrics=["recreation", "food", "greenspace", "employment"]
):

    budgets = (
        session.execute(
            select(Budget).options(
                joinedload(Budget.improvement_features).options(
                    joinedload(ImprovementFeature.dissemination_area)
                )
            )
        )
        .scalars()
        .unique()
        .all()
    )

    metrics_models = []

    for metric in metrics:
        m = session.execute(select(Metric).filter(Metric.name == metric)).scalar()
        if not m:
            m = Metric(name=metric)
            session.add(m)
            session.commit()

        metrics_models.append(m)

    das = session.execute(select(DisseminationArea)).scalars().all()

    to_insert = []
    # defaults should be smaller than the updated
    for da in das:
        for metric in metrics_models:
            score = get_score(da, metric, 1, 20)
            row = {
                "dissemination_area_id": da.id,
                "metric_id": metric.id,
                "score": score,
            }

            to_insert.append(row)

    stmt = insert(BudgetScore)

    session.execute(stmt, to_insert)
    session.commit()

    constructor = lambda: {}

    score_map = defaultdict(constructor)

    for row in to_insert:
        score_map[row["dissemination_area_id"]][row["metric_id"]] = row["score"]

    for budget in budgets:
        print(f"creating scores for budget {budget.id}")

        # this just uses a postgres spatial join to grab the DA containing the feature
        # unfortunately this does not grab all DAs that might be contiguous to a feature, so
        # we'll be a bit inefficient and churn through all the nearby DAs for every feature
        # leading to lots of duplication.....
        # das = {
        #     feature.dissemination_area
        #     for feature in budget.improvement_features
        #     if feature.dissemination_area is not None
        # }
        to_insert = []
        for feature in budget.improvement_features:
            nearby_das = get_nearby_das(feature, session)
            for da in nearby_das:
                for metric in metrics_models:
                    score = get_score(da, metric, 5, 50, score_map[da.id][metric.id])
                    row = {
                        "budget_id": budget.id,
                        "dissemination_area_id": da.id,
                        "metric_id": metric.id,
                        "score": score,
                    }
                    to_insert.append(row)

        stmt = insert(BudgetScore).on_conflict_do_nothing()

        session.execute(stmt, to_insert)
        session.commit()


if __name__ == "__main__":
    engine = create_engine(app_settings.POSTGRES_CONNECTION_STRING)

    with Session(engine) as session:
        print("creating dummy scores...")
        create_dummy_scores(session)
